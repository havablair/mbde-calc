---
title: "Microbial Biomass C & N Calculations"
author: "Hava Blair"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r setup}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(tidy = TRUE)
knitr::opts_chunk$set(tidy.opts = list(width.cutoff=60))

library(tidyverse)
library(glue)

```

## Overview

Starting with the CSV files generated by `01_shimadzu_calcs_from_detail_text.Rmd`, calculate the mass of microbial biomass C and N per unit soil (dry weight equivalent). 

Note that you can run calculations on multiple input files simultaneously. 

A helpful reference on these calculations is: 

Voroney, R., Brookes, P., & Beyaert, R. (2008). Soil microbial biomass C, N, P, and S. In M. R. Carter & E. G. Gregorich (Eds.), Soil sampling and methods of analysis (2nd ed., pp. 637â€“652). CRC Press Taylor & Francis.


## 1 Load data

```{r load, message=FALSE, warning=FALSE}

# list of paths for all files that match "pattern"
data_paths <- dir(path = "temp/", pattern = "npoc_tn_calcs", full.names = TRUE)

# reads raw data in as list column
# this makes it easy to keep multiple runs organized 
data_df <- data.frame(paths = data_paths) %>% 
  mutate(data = map(data_paths, read_csv),
         shimadzu_date = str_extract(paths, "[:digit:]{8}"))

# key to shimadzu runs, group by date for joining with raw data
key <- read_csv("metadata/key_to_shimadzu_runs.csv") %>% 
  rename(shimadzu_date = sh_run_date) %>% 
  mutate(shimadzu_date = as.character(shimadzu_date))

# sample names 
full_names <- read_csv("metadata/sample_ids_demo.csv") 

# soil moisture content (fresh to oven dry, expressed as a proportion)
mc <- read_csv("metadata/grav_moisture_demo.csv") %>% 
  select(sample_id, grav_soil_water_content)

# soil mass used in extractions
# b=baseline, c=chloroform
mass <- read_csv("metadata/soil_mass_demo.csv")
```

## 2 Data joining

I keep a separate spreadsheet that lists the dates, vial numbers, dilution factor, and numerical sample IDs for each run. This is created from my lab notebook, where I recorded which samples were run on a given date. Here, I join that spreadsheet with the raw data from the Shimadzu. Some people choose to enter this information directly into the Shimadzu data table before a run. If this is the case, you can skip this step.

```{r match}
# unnest the list column before we do the joins
data_df_unnest <- data_df %>% 
  unnest(data)

# add shimadzu vial numbers
dd_vial_key <- left_join(data_df_unnest, key, by = c("shimadzu_date", "vial" = "vial_number"))

# add full sample names
dd_names <- left_join(dd_vial_key, full_names, by = "sample_id")

# add moisture content data 
dd_mc <- left_join(dd_names, mc, by = "sample_id")

# important to include "type" in join so baseline and chloroform samples
# are matched to correct mass value
main <- left_join(dd_mc, mass, by = c("sample_id", "type"))

```


## 3 Check for data entry errors: soil mass and moisture

Some QC checks here on mass and moisture data to control for data entry errors (misplaced decimal points usually) that cause big problems down the line. 

For example, we expect most samples to be weighed to 10g +/- 0 0.5g. Flagging data \<9.5g and \>10.5g would be a good way to check this. For the soil moisture I'm expecting proportions 0.1 - 0.6 (10% - 60%). This could also be pulled out in a separate data cleaning script.

```{r checks}

# some graphs to check out mass and moisture data
mc %>% 
  ggplot() + 
  geom_histogram(aes(x = grav_soil_water_content))

mass %>% 
  ggplot() + 
  geom_histogram(aes(x = mass), bins = 15)

```

# 2. Calculate soil mass oven dry equivalent (ODE)

> MS (mass_ode_g) (grams) = soil wet weight (g) x [100 / [100 + WS %]]

```{r dry-mass}
# convert moisture content from proportion to percent
main <-  main %>% 
  mutate(swc_percent = grav_soil_water_content*100)

# calculate oven dry equivalent (ODE) mass 
main <- main %>% 
  mutate(mass_ode_g = round((mass * (100/(100 + swc_percent))), 2)) 

main

```

# 3. Total volume of solution

Calculate total volume of solution in the extraction (VS). In this step you calculate the mass of the soil water, convert it to volume (recall that 1g water = 1 mL water), and add this (small) volume of water to the volume of extractant solution you used. In our case, this is 40mL of 0.5 M $K_2SO_4$

> VS (mL) = [( soil wet weight (g) - soil dry weight (g) ) / 1 g mL \^-1] + extractant volume (mL)

```{r sol-vol}
main <- main %>% 
  mutate(vol_soil_water_ml = mass - mass_ode_g, 
         total_solution_vol = 40 + vol_soil_water_ml)
```

# 4. Blanks

## 4.1 Inspect and visualize blanks (controls)

b = non-fumigated sample  
c = fumigated sample

```{r blank-subset}
# subset blanks and checks 
# if your blanks are called something other than blank or Blank
# update this accordingly 
all_blanks <- main %>% 
  filter(str_detect(sample_id, "bl") | str_detect(sample_id, "Bl"))

```


```{r blank-vals}
# look at blank b and blank c NPOC values
all_blanks %>% 
  ggplot() + 
  geom_point(aes(y = sample_id, x = NPOC_mg_L, color = type))

```

There are a couple strategies you could take here with blanks. Here, I take the average value of the different blanks and use this as a correction. Alternatively, you could add "shimadzu_date" to the `group_by()` call here if you wish to use only blank values from a given run in the calculations. Will require some updates to code below if you go this route. 

```{r blank-stats}
# calculate summary stats
(blanks_summary <- all_blanks %>% 
  group_by(type) %>% 
  summarise(mean_npoc = mean(NPOC_mg_L), 
            sd_npoc = sd(NPOC_mg_L),
            mean_tn = mean(TN_mg_L), 
            sd_tn = sd(TN_mg_L), 
            .groups = "drop"))

# visualize NPOC values for blanks
# most useful when analyzing multiple runs at same time. 
all_blanks %>% 
  ggplot() + 
  geom_violin(aes(x = type, y = NPOC_mg_L, color = type)) +
  geom_point(aes(x = type, y = NPOC_mg_L, color = type)) + 
  ggtitle("NPOC range of blanks") 

# visualize TN values for blanks
# most useful when analyzing multiple runs at same time.
all_blanks %>% 
  ggplot() + 
  geom_violin(aes(x = type, y = TN_mg_L, color = type)) +
  geom_point(aes(x = type, y = TN_mg_L, color = type)) + 
  ggtitle("TN range of blanks") 

```

## 4.2 Save mean blank values for calculations

These values will be subtracted from sample values of NPOC and TN before calculating the final concentrations. Note that "b" and "c" samples have different constants.

b = non-fumigated sample c = fumigated sample

```{r blank-means}
# create row ids for readable indexing below
blanks_row_ids <- blanks_summary %>% 
  column_to_rownames(var = "type")

# view 
blanks_row_ids

# save constants for calculations
npoc_blank_b <- blanks_row_ids["b", "mean_npoc"]
npoc_blank_c <- blanks_row_ids["c", "mean_npoc"]
tn_blank_b <- blanks_row_ids["b", "mean_tn"]
tn_blank_c <- blanks_row_ids["c", "mean_tn"]

```

## 4.3 Correcting C concentration using blank values

First, subtract the concentration of C in the blanks (fumigated (c) and unfumigated (b) ) from the sample concentrations.

> corrected $C_f$ , $C_{uf}$ = result NPOC (b,c) - blank NPOC (b,c)

```{r blank-correct}

# subtract blanks conc from sample conc to get corrected conc
main <- main %>% 
  mutate(cor_npoc = case_when(
    type == "b" ~ round((NPOC_mg_L - npoc_blank_b),4),
    type == "c" ~ round((NPOC_mg_L - npoc_blank_c),4), 
    TRUE ~ 8888
  ), 
  cor_tn = case_when(
        type == "b" ~ round((TN_mg_L - tn_blank_b),4),
    type == "c" ~ round((TN_mg_L - tn_blank_c),4), 
    TRUE ~ 8888
  ))

```

# 5. MBC and MBN Calculations

## 5.1 Calculate mass NPOC and TN

Calculating the mass of extractable C per mass unit soil in the fumigated (c or $C_f$ ) and unfumigated (b or $C_{uf}$ ) samples

> final $C_f$ , $C_uf$ ( $\mu g \; g^{-1}$ soil) = organic C ( $\mu g / mL$ ) x [VS (mL) / MS (g) ]

> final $TN_f$ , $TN_uf$ ( $\mu g \; g^{-1}$ soil) = TN ( $\mu g / mL$ ) x [VS (mL) / MS (g) ]

```{r mass-calc}

main_mass <- main %>% 
  mutate(final_npoc = (cor_npoc * (total_solution_vol / mass_ode_g)), 
         final_tn = (cor_tn * (total_solution_vol / mass_ode_g))) 



```

## 5.2 Address duplicates and check for typos

Do this now to make sure we each sample has "b" and "c" samples to match together. Checking for duplicates and data entry errors.

```{r dups-id}

# add row ids for easier QA/QC
main_mass <- main_mass %>% 
  mutate(row_id = c(1:nrow(main_mass)))

# which samples were run more than once? 
duplicates <- main_mass %>% 
  group_by(sample_id, type) %>% 
  summarise(n = n(), .groups = "drop") %>% 
  filter(n>1)

# go through these duplicates
# address as needed (see below for example)
duplicates

# for easy filtering on ids
dupl_ids <- duplicates$sample_id

```



```{r dups-remove}

# for sample 416, figure out the bad row_id, then exclude using that instead 
# of sample id (b/c not both b & c for sample were bad)
main_mass %>% 
  filter(sample_id %in% dupl_ids) %>% 
  select(row_id, sample_id, type, NPOC_mg_L, shimadzu_date)

# dealing with duplicates
# example of how I would do this
main_clean <- main_mass %>%
  filter(
  # drop end of run duplicate per lab notes
    # using row_id b/c duplicate was run on same day as original (20210409)
!(sample_id == "416" & row_id == 89) 
# could add more conditional statements here to remove other duplicates
    )

# check again
# table should be empty once we've excluded all duplicates

main_clean  %>% 
  filter(sample_id %in% dupl_ids) %>% 
  select(sample_id, type) %>% 
  group_by(sample_id, type) %>% 
  count() %>% 
  filter(n>1)

```

## 5.3 Calculate microbial biomass C & N

Microbial biomass C in the soil (MB-C):

> MB-C ( $\mu g \; g^{-1}$ soil) = ($C_f - C_{uf}) / k_{ec}$)

Here, Voroney et al. comment: "where $k_{ec}$ = 0.35 and represents the efficiency of extraction of microbial biomass C. Values for $k_{ec}$ range from 0.25 to 0.45 (Wu et al. 1990; Joergensen 1996)." See section 0.2 for my thoughts on this.

Microbial biomass N in the soil (MB-N):

> MB-N ( $\mu g \; g^{-1}$ soil) = ($N_f - N_{uf}) / k_{EN}$)

Here, Voroney et al. comment: "where $k_{EN}$ = 0.5 and represents the efficiency of extraction of microbial biomass N. Values for $k_{EN}$ range from 0.18 - 0.54 (Joergensen and Mueller, 1996). "

```{r npoc-soil}

# extraction effiency constants
# CHANGE THESE IF NEEDED. Consult literature for more info. 
kec <- 0.45
ken <- 0.5

#  NPOC (non-purgeable organic carbon)

# select columns
npoc_subset <- main_clean %>% 
  select(sample_id, type, shimadzu_date, final_npoc) %>% 
  filter(type %in% c("b", "c"))

# format data wide
npoc_wide <- npoc_subset %>% 
  pivot_wider(names_from = c(type), values_from = c(final_npoc), names_prefix = "npoc_")

# calculation
npoc_calcs <- npoc_wide %>% 
  mutate(mbc_ug_g_soil = ((npoc_c - npoc_b)/kec))

# add names
npoc_calcs_names <- left_join(npoc_calcs, full_names, by = c("sample_id"))

```


```{r tn-soil}
# TN 

# select columns
tn_subset <- main_clean %>% 
  select(sample_id, type, shimadzu_date, final_tn) %>% 
  filter(type %in% c("b", "c"))

# format data wide
tn_wide = tn_subset %>% 
    pivot_wider(names_from = c(type), values_from = c(final_tn), names_prefix = "tn_")

# calculation
tn_calcs <- tn_wide %>% 
  mutate(mbn_ug_g_soil = ((tn_c - tn_b)/ken))
```


```{r join-soil}
# join NPOC and TN results together into one dataframe
mb_calcs_all <- left_join(npoc_calcs, tn_calcs, by = c("sample_id", "shimadzu_date")) %>% 
  select(sample_id, shimadzu_date, mbc_ug_g_soil, mbn_ug_g_soil) %>% 
  mutate(kec_value = kec,
         ken_value = ken)
  
```

# 6. Save Results

```{r save-result}

todays_date <- lubridate::today() %>% str_replace_all("-", "")

ifelse(dir.exists("results"),
       "results directory exists: proceed to write_csv",
       dir.create("results")
       )

write_csv(mb_calcs_all, glue("results/mbc_mbn_final_calcs_{todays_date}.csv"))

```


